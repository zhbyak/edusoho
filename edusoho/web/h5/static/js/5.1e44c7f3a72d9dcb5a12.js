webpackJsonp([5],{ZJGh:function(e,s,i){"use strict";Object.defineProperty(s,"__esModule",{value:!0});i("XmAh");var t=i("il3B"),o=i("bOdI"),n=i.n(o),a=i("Xxa5"),r=i.n(a),c=i("exGp"),d=i.n(c),l=i("Dd8w"),u=i.n(l),h=(i("eqfM"),i("/QYm")),v=i("FVyg"),g=i("L/LV"),m=i("NYxO"),f=i("NyOD"),p=i("1JqO"),w={name:"login",components:{EDrag:v.a},props:{show:{type:Boolean,default:!1},processIsDone:{type:Boolean,default:!1}},data:function(){return{visible:this.show,userinfo:{mobile:"",dragCaptchaToken:void 0,smsCode:"",smsToken:"",type:"sms_login"},dragEnable:!1,dragKey:0,errorMessage:{mobile:"",password:""},validated:{mobile:!1},loginMode:"fastLoginMode",currentLoginMode:{},fastLoginMode:{accountPlaceholder:"请输入手机号",passwordPlaceholder:"请输入验证码"},normalLoginMode:{accountPlaceholder:"请输入手机号/邮箱号/用户名",passwordPlaceholder:"请输入密码"}}},computed:u()({},Object(m.mapState)({isLogin:function(e){return!!e.token}}),{btnDisable:function(){return"fastLoginMode"===this.loginMode?!(/^1\d{10}$/.test(this.userinfo.mobile)&&this.userinfo.smsCode):!(this.userinfo.mobile&&this.userinfo.smsCode&&this.validateEmail())},cansentCode:function(){return!(this.count.codeBtnDisable||!this.validated.mobile)}}),watch:{show:function(){this.visible=this.show}},mixins:[f.a,p.a,g.a],created:function(){this.currentLoginMode=this[this.loginMode]},methods:u()({},Object(m.mapActions)(["addUser","setMobile","sendSmsSend","fastLogin","userLogin"]),{jump2register:function(){this.$router.push({name:"register",query:{redirect:this.$route.fullPath}})},onSubmit:function(){var s=this;this.btnDisable||("fastLoginMode"!==this.loginMode?this.userLogin({username:this.userinfo.mobile,password:this.userinfo.smsCode}).then(function(e){s.updateShow(),s.$emit("submit")}).catch(function(e){h.a.fail(e.message),4040104===e.code&&(s.errorMessage.mobile=e.message,s.errorMessage.password=""),5000116===e.code&&(s.errorMessage.mobile="",s.errorMessage.password=e.message),s.userinfo.smsCode=""}):this.handleSubmit(this.handleSubmitSuccess,this.handleSubmitFail))},updateShow:function(){this.$emit("update:show",!1)},updateProcessIsDone:function(){this.$emit("update:processIsDone",!0)},handleSmsSuccess:function(e){this.userinfo.dragCaptchaToken=e,this.handleSendSms()},handleSubmitSuccess:function(){this.updateShow(),this.$emit("submit")},handleSubmitFail:function(e){this.errorMessage.password=e},changeLoginMode:function(){this.loginMode="fastLoginMode"===this.loginMode?"normalLoginMode":"fastLoginMode",this.currentLoginMode=this[this.loginMode],this.userinfo.mobile="",this.userinfo.smsCode="",this.errorMessage.mobile="",this.errorMessage.password=""},validateEmail:function(){if(this.userinfo.mobile.includes("@")){var e=/^\w+@\w+(\.\w+)+$/;return e.test(this.userinfo.mobile)?this.errorMessage.mobile="":this.errorMessage.mobile="邮箱输入错误",e.test(this.userinfo.mobile)}return!0}})},C={render:function(){var s=this,e=s.$createElement,i=s._self._c||e;return i("div",{staticClass:"login"},[i("van-action-sheet",{attrs:{title:" "},on:{close:function(e){s.updateShow(s.show)}},model:{value:s.visible,callback:function(e){s.visible=e},expression:"visible"}},[i("div",{staticClass:"login__container"},[i("div",{staticClass:"receive-login-input"},[i("van-field",{attrs:{type:"text",placeholder:s.currentLoginMode.accountPlaceholder,clearable:"",border:!1,"error-message":s.errorMessage.mobile},on:{focus:function(e){s.errorMessage.mobile=""},blur:function(e){"fastLoginMode"===s.loginMode?s.validateMobileOrPsw("mobile"):s.validateEmail()},input:function(e){"fastLoginMode"===s.loginMode&&s.validatedChecker()}},model:{value:s.userinfo.mobile,callback:function(e){s.$set(s.userinfo,"mobile",e)},expression:"userinfo.mobile"}})],1),s._v(" "),i("div",{staticClass:"receive-login-input"},[i("van-field",{ref:"smsCode",attrs:{type:"fastLoginMode"===s.loginMode?"text":"password",border:!1,clearable:"",maxlength:"fastLoginMode"===s.loginMode?6:64,placeholder:s.currentLoginMode.passwordPlaceholder,"error-message":s.errorMessage.password},on:{focus:function(e){s.errorMessage.password=""}},model:{value:s.userinfo.smsCode,callback:function(e){s.$set(s.userinfo,"smsCode",e)},expression:"userinfo.smsCode"}},[i("div",{directives:[{name:"show",rawName:"v-show",value:"fastLoginMode"===s.loginMode,expression:"loginMode === 'fastLoginMode'"}],class:["code-btn",s.cansentCode?"":"code-btn--disabled"],attrs:{slot:"button"},on:{click:s.clickSmsBtn},slot:"button"},[i("span",{directives:[{name:"show",rawName:"v-show",value:!s.count.showCount,expression:"!count.showCount"}]},[s._v("发送验证码")]),s._v(" "),i("span",{directives:[{name:"show",rawName:"v-show",value:s.count.showCount,expression:"count.showCount"}]},[s._v(s._s(s.count.num)+" s")])])]),s._v(" "),i("router-link",{staticClass:"reset-password",attrs:{to:"/setting/password/reset",tag:"div"}},[s._v("忘记密码？\n        ")])],1),s._v(" "),s.dragEnable?i("div",{staticClass:"mobile-drag"},[i("div",{staticClass:"mobile-drag-content"},[s.dragEnable?i("e-drag",{key:s.dragKey,ref:"dragComponent",attrs:{limitType:"receive_coupon"},on:{success:s.handleSmsSuccess}}):s._e()],1)]):s._e(),s._v(" "),i("div",{class:["receive-login__btn",s.btnDisable?"disabled__btn":""],on:{click:s.onSubmit}},[s._v("登录并领取\n      ")]),s._v(" "),i("div",{staticClass:"choice-bar"},[i("div",{staticClass:"left"},[i("div",{directives:[{name:"show",rawName:"v-show",value:!s.isLogin,expression:"!isLogin"}],on:{click:s.jump2register}},[s._v("注册账号")])]),s._v(" "),i("div",{directives:[{name:"show",rawName:"v-show",value:"fastLoginMode"===s.loginMode,expression:"loginMode === 'fastLoginMode'"}],staticClass:"right",on:{click:s.changeLoginMode}},[s._v("使用其他方式登录 >>")]),s._v(" "),i("div",{directives:[{name:"show",rawName:"v-show",value:"normalLoginMode"===s.loginMode,expression:"loginMode === 'normalLoginMode'"}],staticClass:"right",on:{click:s.changeLoginMode}},[s._v("使用手机快捷登录 >>")])]),s._v(" "),i("div",{staticClass:"receive-login__text"},[i("span",{directives:[{name:"show",rawName:"v-show",value:"fastLoginMode"===s.loginMode,expression:"loginMode === 'fastLoginMode'"}],staticClass:"receive-login-tools"},[s._v("新用户领取将为您自动注册")]),s._v(" "),i("div",{directives:[{name:"show",rawName:"v-show",value:"normalLoginMode"===s.loginMode,expression:"loginMode === 'normalLoginMode'"}],staticClass:"third-part-login"})])])])],1)},staticRenderFns:[]};var b=i("VU/8")(w,C,!1,function(e){i("eNeh")},"data-v-62830581",null).exports,_=i("gyMJ"),M={name:"valid-card",components:{eLogin:b},data:function(){return{coin:"",date:"",money:0,password:"",show:!1,invalidCard:!1,initProcess:!1,processIsDone:!1,message:"",isECard:void 0,token:"",cash:0,cardStatusList:{expired:"卡已过期，去看看其他精品吧～",invalid:"卡已失效，去看看其他精品吧～",recharged:"",usedByOther:"卡已被其他人充值，去看看其他精品吧～",empty:"卡已被抢完，去看看其他精品吧～"},isLoading:0}},computed:u()({},Object(m.mapState)({account:function(e){return e.user.verifiedMobile||e.user.nickname},isLogin:function(e){return!!e.token},settingsName:function(e){return e.settings.name},userToken:function(e){return e.token},userId:function(e){return e.user.id}}),{formattedPassword:function(){return this.password.toString().replace(/\W/g,"").replace(/....(?!$)/g,"$& ")}}),created:function(){document.title="学习卡充值",this.token=this.$route.params.token||"",this.password=this.$route.params.password||"",this.isECard=!!this.token.length,this.init()},methods:{init:function(){var s=this;return d()(r.a.mark(function e(){return r.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,s.getCoin();case 2:return e.next=4,s.getCash();case 4:!0===s.isECard?s.getMoneyCardByToken():s.getMoneyCardByPassword();case 5:case"end":return e.stop()}},e,s)}))()},getCoin:function(){var s=this;return _.a.getCoin().then(function(e){s.coin=e.name,s.isLoading+=1}).catch(function(e){})},switchCharge:function(e,s){var i=this;this.isLoading-=1,_.a[e]({query:n()({},s,this[s]),headers:{"Content-Type":"application/x-www-form-urlencoded","X-Auth-Token":this.userToken}}).then(function(e){i.isLoading+=1,e.cardPassword&&(i.password=e.cardPassword),!0===e.success?(i.invalidCard=!1,i.message=e.message,i.cash=e.cash):(i.invalidCard=!0,i.message=e.error.message,"recharged"===e.error.status&&(i.message=i.cardStatusList.recharged)),i.processIsDone=!0}).catch(function(e){})},switchSubmit:function(){this.initProcess?this.initStatus():this.submit()},switchUser2charge:function(){var s=this;return d()(r.a.mark(function e(){return r.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,s.getCash();case 2:!0===s.isECard?s.chargeMoneyCardByToken():s.chargeMoneyCardByPassword();case 3:case"end":return e.stop()}},e,s)}))()},initStatus:function(){this.initProcess=!1,this.invalidCard?this.processIsDone=!0:this.isLogin||this.jump2login()},getCash:function(){var s=this;return _.a.getCash({query:{userId:this.userId}}).then(function(e){s.cash=e.cash,s.cardStatusList.recharged="之前已充值，当前账户余额："+e.cash+s.coin+"<br/>尽情去购物啦～"}).catch(function(e){})},getMoneyCardByToken:function(){var s=this;_.a.getMoneyCardByToken({query:{token:this.token}}).then(function(e){s.isLoading+=1,s.date=e.deadline,s.money=e.coin,"normal"!==e.batchStatus&&(s.message=s.cardStatusList[e.batchStatus],s.initProcess=!1,s.invalidCard=!0,s.processIsDone=!0)}).catch(function(e){s.$router.push("/")})},getMoneyCardByPassword:function(){var s=this;_.a.getMoneyCardByPassword({query:{password:this.password}}).then(function(e){s.isLoading+=1,s.date=e.deadline,s.money=e.coin,s.code=e.password,"normal"===e.cardStatus||e.rechargeUserId===s.userId&&"receive"===e.cardStatus||(e.cardStatus=e.rechargeUserId===s.userId||"recharged"!==e.cardStatus&&"receive"!==e.cardStatus?e.cardStatus:"usedByOther",s.message=s.cardStatusList[e.cardStatus],s.initProcess=!1,s.invalidCard=!0,s.processIsDone=!0)}).catch(function(e){s.$router.push("/")})},submit:function(){var e=this;!this.invalidCard&&this.isLogin&&t.a.confirm({title:"将充值到当前登录账户",message:this.account,cancelButtonText:"充值其他账户"}).then(function(){!0===e.isECard?e.chargeMoneyCardByToken():e.chargeMoneyCardByPassword()}).catch(function(){e.jump2login()}),this.invalidCard||this.isLogin||this.jump2login()},jump2login:function(){this.show=!0},chargeMoneyCardByToken:function(){this.switchCharge("chargeMoneyCardByToken","token")},chargeMoneyCardByPassword:function(){this.switchCharge("chargeMoneyCardByPassword","password")}}},y={render:function(){var s=this,e=s.$createElement,i=s._self._c||e;return i("div",{staticClass:"valid-card"},[2!==s.isLoading?i("e-loading"):s._e(),s._v(" "),i("div",{staticClass:"container"},[i("div",{staticClass:"top text-overflow"},[s._v("\n      "+s._s(s.settingsName)+"\n    ")]),s._v(" "),i("div",{staticClass:"middle"},[i("div",{staticClass:"card"},[i("div",{staticClass:"valid-date"},[s._v("\n          学习卡充值有效期至："+s._s(s.date)+"\n        ")]),s._v(" "),i("div",{staticClass:"money"},[s._v(s._s(s.money)+"\n          "),i("span",[s._v(s._s(s.coin))])]),s._v(" "),i("div",{staticClass:"password"},[s._v(s._s(s.formattedPassword))])]),s._v(" "),i("div",{staticClass:"result-box"},[i("div",{directives:[{name:"show",rawName:"v-show",value:!s.initProcess&&!s.invalidCard&&this.isLogin&&!s.processIsDone,expression:"!initProcess && !invalidCard && this.isLogin && !processIsDone"}],staticClass:"result-box__valid-card"},[i("div",[s._v("将充值到当前账户："+s._s(s.account))]),s._v(" "),i("a",{staticClass:"link",attrs:{href:"javascript: void(0)"},on:{click:s.jump2login}},[s._v("是否放入其他账户")])]),s._v(" "),i("div",{directives:[{name:"show",rawName:"v-show",value:s.invalidCard,expression:"invalidCard"}],staticClass:"result-box__invalid-card--process-is-done"},[s._m(0),s._v(" "),i("div",{staticClass:"res-msg",domProps:{innerHTML:s._s(s.message)}})]),s._v(" "),i("div",{directives:[{name:"show",rawName:"v-show",value:s.processIsDone&&!s.invalidCard,expression:"processIsDone && !invalidCard"}],staticClass:"result-box__valid-card--process-is-done"},[s._m(1),s._v(" "),i("div",{staticClass:"result-box__account"},[s._v("当前账户余额："+s._s(s.cash)+s._s(s.coin))]),s._v(" "),i("div",[s._v("尽情去购物啦～")])])])]),s._v(" "),i("div",{staticClass:"bottom"},[i("van-button",{directives:[{name:"show",rawName:"v-show",value:!s.processIsDone,expression:"!processIsDone"}],attrs:{type:"primary",block:""},on:{click:s.switchSubmit}},[s._v("立即充值")]),s._v(" "),i("van-button",{directives:[{name:"show",rawName:"v-show",value:!s.initProcess&&s.processIsDone,expression:"!initProcess && processIsDone"}],attrs:{type:"primary",block:"",to:"/"}},[s._v("去首页")])],1)]),s._v(" "),i("e-login",{attrs:{show:s.show},on:{"update:show":function(e){s.show=e},submit:s.switchUser2charge}})],1)},staticRenderFns:[function(){var e=this.$createElement,s=this._self._c||e;return s("div",{staticClass:"icon"},[s("i",{staticClass:"iconfont icon-Fail"}),this._v(" "),s("span",[this._v("充值失败")])])},function(){var e=this.$createElement,s=this._self._c||e;return s("div",{staticClass:"icon"},[s("i",{staticClass:"result-box__icon-Success"}),this._v(" "),s("span",[this._v("充值成功")])])}]},L=i("VU/8")(M,y,!1,null,null,null);s.default=L.exports},eNeh:function(e,s){}});