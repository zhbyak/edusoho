webpackJsonp([43],{cLXl:function(e,s,t){"use strict";Object.defineProperty(s,"__esModule",{value:!0});t("eqfM");var n=t("/QYm"),i=t("fZjL"),o=t.n(i),a=t("Dd8w"),c=t.n(a),u=t("NYxO"),r=t("gyMJ");function l(e){for(var s=e.toString().split("."),t=["","0","00","000","0000"].reverse(),n=0;n<s.length;n+=1){var i=s[n].length;s[n]=t[i]+s[n]}return s.join("")}var d=function(e,s){var t=l(e),n=l(s);return Number(t)<=Number(n)},v=t("Xxa5"),p=t.n(v),m=t("exGp"),f=t.n(m),h=t("FVyg"),_=(t("SgDA"),t("KFVb"),t("NyOD")),g=t("1JqO"),C=t("L/LV"),b={name:"coupon-fast",mixins:[_.a,g.a,C.a],components:{EDrag:h.a},data:function(){return{isShow:!1,userinfo:{mobile:"",dragCaptchaToken:void 0,smsCode:"",smsToken:"",type:"sms_login"},dragEnable:!1,dragKey:0,errorMessage:{mobile:""},validated:{mobile:!1},count:{showCount:!1,num:60,codeBtnDisable:!1}}},computed:{btnDisable:function(){return!(this.userinfo.mobile&&this.userinfo.smsCode)},cansentCode:function(){return!(this.count.codeBtnDisable||!this.validated.mobile)}},methods:c()({},Object(u.mapActions)(["addUser","setMobile","sendSmsSend","fastLogin"]),{handleSubmitSuccess:function(){var e={mobile:this.userinfo.mobile,smsToken:this.userinfo.smsToken,smsCode:this.userinfo.smsCode};this.$emit("lReceiveCoupon",e)},handleSmsSuccess:function(e){this.userinfo.dragCaptchaToken=e,this.handleSendSms()}})},w={render:function(){var s=this,e=s.$createElement,t=s._self._c||e;return t("div",{staticClass:"coupon-receive-login"},[t("div",{staticClass:"receive-login-input"},[t("van-field",{attrs:{type:"number",placeholder:"请输入手机号码",clearable:"",border:!1,"error-message":s.errorMessage.mobile},on:{blur:function(e){s.validateMobileOrPsw("mobile")},keyup:function(e){s.validatedChecker()}},model:{value:s.userinfo.mobile,callback:function(e){s.$set(s.userinfo,"mobile",e)},expression:"userinfo.mobile"}})],1),s._v(" "),s.dragEnable?t("div",{staticClass:"mobile-drag"},[t("div",{staticClass:"mobile-drag-content"},[s.dragEnable?t("e-drag",{key:s.dragKey,ref:"dragComponent",attrs:{limitType:"receive_coupon"},on:{success:s.handleSmsSuccess}}):s._e()],1)]):s._e(),s._v(" "),t("div",{staticClass:"receive-login-input"},[t("van-field",{ref:"smsCode",attrs:{type:"number",placeholder:"请输入验证码",clearable:"",border:!1,maxlength:"6"},model:{value:s.userinfo.smsCode,callback:function(e){s.$set(s.userinfo,"smsCode",e)},expression:"userinfo.smsCode"}},[t("div",{class:["code-btn",s.cansentCode?"":"code-btn--disabled"],attrs:{slot:"button"},on:{click:s.clickSmsBtn},slot:"button"},[t("span",{directives:[{name:"show",rawName:"v-show",value:!s.count.showCount,expression:"!count.showCount"}]},[s._v("发送验证码")]),s._v(" "),t("span",{directives:[{name:"show",rawName:"v-show",value:s.count.showCount,expression:"count.showCount"}]},[s._v(s._s(s.count.num)+" s")])])])],1),s._v(" "),t("div",{class:["receive-login__btn",s.btnDisable?"disabled__btn":""],on:{click:function(e){s.handleSubmit(s.handleSubmitSuccess)}}},[s._v("\n    立即领取\n  ")]),s._v(" "),s._m(0)])},staticRenderFns:[function(){var e=this.$createElement,s=this._self._c||e;return s("div",{staticClass:"receive-login__text"},[s("span",{staticClass:"receive-login-tools"},[this._v("新用户领取将为您自动注册")])])}]},x=t("VU/8")(b,w,!1,null,null,null).exports,k=t("OPcZ"),S=t("w/qc"),y=t("162o"),R={name:"fast-receive",components:{fastLogin:x},mixins:[k.a,S.a],data:function(){return{coupons:null,currentUserCoupon:null,login:!1,canuse:!1,hasReceive:!1,receiveFail:!1,failmessage:"优惠券已失效",successmessage:"",loginMethods:!1}},created:function(){this.getCouponInfo()},computed:c()({},Object(u.mapState)({user:function(e){return e.user},isLoading:function(e){return e.isLoading},settings:function(e){return e.settings},couponSwitch:function(e){return e.couponSwitch}}),{username:{get:function(){if(this.$store.state.token)return this.user.verifiedMobile?this.user.verifiedMobile:this.user.nickname}}}),filters:{couponType:function(e){return"discount"==e?"折":"元"}},methods:{getCouponInfo:function(){var t=this;return f()(p.a.mark(function e(){var s;return p.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return s=t.$route.params.token,e.next=3,r.a.getCouponInfo({query:{token:s}}).then(function(e){t.coupons=e,t.cantUseCoupon(e)||t.isLogin()}).catch(function(e){n.a.fail(e.message)});case 3:case"end":return e.stop()}},e,t)}))()},isLogin:function(){if(this.$store.state.token){this.login=!0;var e={token:this.$route.params.token};this.newReceiveCoupon(e)}else;},couponType:function(e){var s=e.targetDetail.numType,t=e.targetDetail.product;if("single"===s)switch(t){case"course":case"classroom":return"指定商品";case"vip":return"指定会员";default:return""}else if("all"===s)switch(t){case"course":return"全部课程";case"classroom":return"全部班级";case"all":return"全部商品";case"vip":return"全部会员";default:return""}else switch(t){case"course":case"classroom":return"部分商品";default:return""}},newReceiveCoupon:function(e,s){var t=this;r.a.pluginsReceiveCoupon({data:e}).then(function(e){if(s)return n.a.success("领取成功，正在跳转到详情页..."),void Object(y.setTimeout)(function(){t.useCoupon()},3e3);t.currentUserCoupon=e,t.successmessage="领取成功，优惠券已放入",t.hasReceive=!0}).catch(function(e){s?"5004507"==e.code?(n.a.success("您已领取过该优惠券，正在跳转到详情页..."),Object(y.setTimeout)(function(){t.useCoupon()},3e3)):n.a.fail("领取失败，"+e.message):"5004507"==e.code?(t.successmessage="您已领取过，优惠券已放入",t.hasReceive=!0):(t.receiveFail=!0,t.failmessage="领取失败，"+e.message)})},useCoupon:function(){null!=this.currentUserCoupon&&this.currentUserCoupon.deadline&&this.isOld(this.currentUserCoupon.deadline)?n.a.fail("优惠券已过期"):this.hasreceiveCoupon(this.coupons)},lReceiveCoupon:function(e,s){var t={token:this.$route.params.token};this.loginMethods=!0,this.newReceiveCoupon(t,!0)},isOld:function(e){var s=new Date,t=new Date(Date.parse(e));return s.getTime()>t.getTime()+864e5},cantUseCoupon:function(e){return null!=e.currentUserCoupon?(this.currentUserCoupon=e.currentUserCoupon,this.successmessage="您已领取过该批次优惠券，优惠券已放入",this.hasReceive=!0,!(this.canuse=!1)):0==Number(e.unreceivedNum)?(this.failmessage="优惠券已领完",this.receiveFail=!0,!(this.canuse=!1)):e.deadline&&this.isOld(e.deadline)?(this.failmessage="优惠券已过期",this.receiveFail=!0,!(this.canuse=!1)):!(this.canuse=!0)}}},U={render:function(){var s=this,e=s.$createElement,t=s._self._c||e;return s.coupons?t("div",{staticClass:"coupon-receive"},[s.isLoading?t("e-loading"):s._e(),s._v(" "),t("div",{staticClass:"coupon-receive-title text-overflow"},[s._v("\n        "+s._s(s.settings.name)+"\n    ")]),s._v(" "),t("div",{staticClass:"coupon-receive-ticket"},[t("div",{staticClass:"ticket-discount"},[t("span",{staticClass:"rate"},[s._v(s._s(parseFloat(s.coupons.rate)))]),s._v(s._s(s._f("couponType")(s.coupons.type))+"\n            "),t("span",[s._v("优惠券")])]),s._v(" "),t("div",{staticClass:"ticket-expire text-overflow"},["day"===s.coupons.deadlineMode?t("span",[null!=s.currentUserCoupon?t("span",[s._v("\n                   优惠券有效至："+s._s(s.receiveTimeExpire(s.currentUserCoupon.deadline))+"\n                ")]):s._e(),s._v(" "),null==s.currentUserCoupon?t("span",[s._v("\n                   领取后"+s._s(s.coupons.fixedDay)+"天内有效\n                ")]):s._e()]):s._e(),s._v(" "),"time"===s.coupons.deadlineMode?t("span",[t("span",{directives:[{name:"show",rawName:"v-show",value:!s.hasReceive,expression:"!hasReceive"}]},[s._v("领券截止日期：")]),s._v(" "),t("span",{directives:[{name:"show",rawName:"v-show",value:s.hasReceive,expression:"hasReceive"}]},[s._v("优惠券有效至：")]),s._v("\n                "+s._s(s.receiveTimeExpire(s.coupons.deadline))+"\n            ")]):s._e()]),s._v(" "),t("div",{staticClass:"ticket-range text-overflow"},[s._v("适用于："+s._s(s.couponType(s.coupons)))])]),s._v(" "),s.hasReceive&&!s.loginMethods&&s.couponSwitch?t("div",{staticClass:"receive-status"},[t("img",{staticClass:"status-icon",attrs:{src:"static/images/coupon-yes.png"}}),s._v(" "),t("div",{staticClass:"status-text"},[s._v(s._s(s.successmessage))]),s._v(" "),t("div",{staticClass:"status-user"},[s._v(s._s(s.username)+"账户")]),s._v(" "),t("div",{staticClass:"status__btn",on:{click:function(e){s.useCoupon()}}},[s._v("立即使用")])]):s._e(),s._v(" "),s.receiveFail&&!s.loginMethods||!s.couponSwitch?t("div",{staticClass:"receive-status"},[t("img",{staticClass:"status-icon",attrs:{src:"static/images/coupon-no.png"}}),s._v(" "),t("div",{staticClass:"status-text"},[s._v(s._s(s.failmessage))])]):s._e(),s._v(" "),!s.login&&s.canuse&&s.couponSwitch?t("fast-login",{on:{lReceiveCoupon:s.lReceiveCoupon}}):s._e()],1):s._e()},staticRenderFns:[]},M=t("VU/8")(R,U,!1,null,null,null).exports,T={name:"pass-receive",mixins:[k.a,S.a],data:function(){return{item:{},message:"",isReceive:!0}},computed:c()({couponStatus:function(){return o()(this.item).length?"coupon-receive-success":""}},Object(u.mapState)(["couponSwitch"])),created:function(){var s=this;if(this.couponSwitch){var e=this.$route.params.token;this.$store.state.token?e&&r.a.receiveCoupon({data:{token:e}}).then(function(e){s.item=e,s.message="恭喜您成功领取了一张优惠券！"}).catch(function(e){s.message="优惠券领取失败！",n.a.fail(e.message)}):this.$router.push({name:"login",query:{redirect:this.$route.fullPath}})}else n.a.fail("优惠券已失效")}},$={render:function(){var s=this,e=s.$createElement,t=s._self._c||e;return t("div",{staticClass:"coupon-receive-page"},[t("div",{class:["coupon-card-bg","clearfix",s.couponStatus]},[t("div",{staticClass:"coupon-info"},[s._v(s._s(s.message))]),s._v(" "),Object.keys(s.item).length?t("div",{staticClass:"e-coupon__body"},[t("div",{staticClass:"e-coupon__header clearfix"},[t("span",{staticClass:"e-coupon__price",domProps:{innerHTML:s._s(s.priceHtml(s.item))}}),s._v(" "),t("div",{staticClass:"e-coupon__name"},[t("div",{staticClass:"text-overflow text-14 coupon-name"},[s._v(s._s(s.item.name))]),s._v(" "),s.item.deadlineMode&&"time"!==s.item.deadlineMode?s._e():t("span",{staticClass:"text-10"},[s._v(s._s(s.timeExpire(s.item.createdTime,s.item.deadline)))]),s._v(" "),"day"!==s.item.deadlineMode||s.item.currentUserCoupon?s._e():t("span",{staticClass:"text-10"},[s._v("领取后"+s._s(s.item.fixedDay)+"天内有效")]),s._v(" "),"day"===s.item.deadlineMode&&s.item.currentUserCoupon?t("span",{staticClass:"text-10"},[s._v(s._s(s.timeExpire(s.item.createdTime,s.item.currentUserCoupon.deadline)))]):s._e()]),s._v(" "),t("span",{staticClass:"coupon-button",on:{click:function(e){s.couponHandle(s.item,s.isReceive)}}},[s._v("去使用")])]),s._v(" "),t("div",{staticClass:"e-coupon__middle"}),s._v(" "),t("div",{staticClass:"e-coupon__bottom text-overflow"},[s._v("\n        可用范围："+s._s(s.scopeFilter(s.item))+"\n      ")])]):s._e()])])},staticRenderFns:[]},O={components:{fastReceive:M,passReceive:t("VU/8")(T,$,!1,null,null,null).exports},data:function(){return{sitePlugins:0,cloudSetting:0}},created:function(){this.getsitePlugins()},computed:c()({},Object(u.mapState)({isLoading:function(e){return e.isLoading}})),methods:{getsitePlugins:function(){var s=this;r.a.sitePlugins({query:{pluginName:"coupon"}}).then(function(e){0<o()(e).length&&(d("2.2.10",e.version)?s.sitePlugins=1:s.sitePlugins=2,s.getsettingsCloud())}).catch(function(e){n.a.fail(e.message)})},getsettingsCloud:function(){var s=this;r.a.settingsCloud().then(function(e){e.sms_enabled?s.cloudSetting=1:s.cloudSetting=2}).catch(function(e){n.a.fail(e.message)})}}},D={render:function(){var e=this,s=e.$createElement,t=e._self._c||s;return t("div",{staticClass:"receive-all"},[e.isLoading?t("e-loading"):e._e(),e._v(" "),1==e.cloudSetting&&1==e.sitePlugins?t("fast-receive"):e._e(),e._v(" "),2==e.cloudSetting||2==e.sitePlugins?t("pass-receive"):e._e()],1)},staticRenderFns:[]},L=t("VU/8")(O,D,!1,null,null,null);s.default=L.exports}});